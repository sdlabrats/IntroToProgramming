<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Asteroids (Configurable)</title>
<style>
    html, body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: black;
    }
    #score {
        position: absolute;
        top: 12px;
        left: 12px;
        font-family: monospace;
        font-size: 22px;
        color: white;
        z-index: 10;
    }
</style>
</head>
<body>

<canvas id="game" tabindex="0"></canvas>
<div id="score">Score: 0</div>

<script>
/* ============================================================
   =====================  CONSTANTS  ===========================
   ============================================================ */

const CONST = {
    PLAYER: {
        ACCEL: 0.10,
        ROT_SPEED: 0.05,
        DRAG: 0.995,
        START_INVULN: 0, // ms of invulnerability after restart
    },
    BULLET: {
        SPEED: 8,
        LIFETIME: 90,
        COOLDOWN: 12
    },
    ASTEROIDS: {
        START_COUNT: 2,
        SPEED_MIN: 0.2,
        SPEED_MAX: 2,
        SIZES: {
            massive: 90,
            mega: 64,
            large: 45,
            medium: 28,
            small: 16
        },
        POINTS: {
            massive: 10,
            mega: 20,
            large: 20,
            medium: 50,
            small: 100
        }
    },
    STARS: {
        LAYER1_SPEED: 1,
        LAYER2_SPEED: 2,
        LAYER3_SPEED: 3
    }
};


/* ============================================================
   =====================  SETUP & RESIZE  ======================
   ============================================================ */

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
let W, H;

function resize() {
    canvas.width = W = window.innerWidth;
    canvas.height = H = window.innerHeight;
}
window.onresize = resize;
resize();
canvas.focus();


/* ============================================================
   ========================  INPUT  ============================
   ============================================================ */

const keys = {};
window.addEventListener("keydown", e => keys[e.key] = true);
window.addEventListener("keyup",   e => keys[e.key] = false);

window.addEventListener("keydown", e => {
    if (/*!player.alive &&*/ e.key.toLowerCase() === "r") restartGame();
});


/* ============================================================
   ==================== PARALLAX STARS =========================
   ============================================================ */

function makeStars(count, speed) {
    let arr = [];
    for (let i = 0; i < count; i++) {
        arr.push({
            x: Math.random()*W,
            y: Math.random()*H,
            tw: Math.random()*Math.PI*2,
            speed
        });
    }
    return arr;
}

const stars1 = makeStars(80,  CONST.STARS.LAYER1_SPEED);
const stars2 = makeStars(140, CONST.STARS.LAYER2_SPEED);
const stars3 = makeStars(260, CONST.STARS.LAYER3_SPEED);

function drawStars(list) {
    list.forEach(s => {
        s.tw += 0.05;
        let b = 0.5 + Math.sin(s.tw)*0.5;

        ctx.globalAlpha = b;
        ctx.fillStyle = "white";
        ctx.fillRect(s.x, s.y, 2, 2);

        // parallax movement
        if (player.alive) {
            s.x -= player.vx * (s.speed * 0.03);
            s.y -= player.vy * (s.speed * 0.03);
        }

        // wrap
        if (s.x < 0) s.x += W;
        if (s.x > W) s.x -= W;
        if (s.y < 0) s.y += H;
        if (s.y > H) s.y -= H;

        ctx.globalAlpha = 1;
    });
}


/* ============================================================
   ========================  PLAYER  ===========================
   ============================================================ */

const player = {
    x: W/2, y: H/2,
    vx: 0, vy: 0,
    angle: 0,
    alive: true,
    cooldown: 0
};

function resetPlayer() {
    player.x = W/2;
    player.y = H/2;
    player.vx = 0;
    player.vy = 0;
    player.angle = 0;
    player.cooldown = 0;
    player.alive = true;
}

function drawPlayer() {
    ctx.save();
    ctx.translate(player.x, player.y);
    ctx.rotate(player.angle);

    ctx.strokeStyle = "white";
    ctx.lineWidth = 2;

    // Ship triangle
    ctx.beginPath();
    ctx.moveTo(15, 0);
    ctx.lineTo(-10, -10);
    ctx.lineTo(-10, 10);
    ctx.closePath();
    ctx.stroke();

    // Thruster flame
    if (keys["ArrowUp"]) {
        ctx.strokeStyle = "orange";
        ctx.beginPath();
        ctx.moveTo(-10, -6);
        ctx.lineTo(-23 - Math.random()*5, 0);
        ctx.lineTo(-10, 6);
        ctx.stroke();
    }

    ctx.restore();
}


/* ============================================================
   ======================== BULLETS ============================
   ============================================================ */

let bullets = [];

function shoot() {
    if (player.cooldown > 0) return;
    player.cooldown = CONST.BULLET.COOLDOWN;

    bullets.push({
        x: player.x + Math.cos(player.angle)*15,
        y: player.y + Math.sin(player.angle)*15,
        vx: Math.cos(player.angle) * CONST.BULLET.SPEED,
        vy: Math.sin(player.angle) * CONST.BULLET.SPEED,
        life: CONST.BULLET.LIFETIME
    });
}

function updateBullets() {
    bullets.forEach(b => {
        b.x += b.vx;
        b.y += b.vy;
        b.life--;

        if (b.x < 0) b.x += W;
        if (b.x > W) b.x -= W;
        if (b.y < 0) b.y += H;
        if (b.y > H) b.y -= H;
    });

    bullets = bullets.filter(b => b.life > 0);
}

function drawBullets() {
    ctx.fillStyle = "white";
    bullets.forEach(b => {
        ctx.beginPath();
        ctx.arc(b.x, b.y, 2, 0, Math.PI*2);
        ctx.fill();
    });
}


/* ============================================================
   ======================= ASTEROIDS ===========================
   ============================================================ */

function randSpeed() {
    return (Math.random() < 0.5 ? -1 : 1) *
           (CONST.ASTEROIDS.SPEED_MIN +
            Math.random()*(CONST.ASTEROIDS.SPEED_MAX - CONST.ASTEROIDS.SPEED_MIN));
}

function randInt(min, max) {
   return Math.floor(Math.random() * (max - min + 1)) + min;
}

function makeAsteroid(size, x=null, y=null) {
    let randomAngle = (randInt(1, 360) / 180) * Math.PI
    
    return {
        x: x ?? Math.cos(randomAngle) * (W / 4),
        y: y ?? Math.sin(randomAngle) * (H / 4),
        vx: randSpeed(),
        vy: randSpeed(),
        size,
        r: CONST.ASTEROIDS.SIZES[size],
        hue: Math.random()*360
    };
}

let asteroids = [];

function initAsteroids() {
    asteroids = [];
    for (let i=0; i<CONST.ASTEROIDS.START_COUNT; i++)
        asteroids.push(makeAsteroid("massive"));
}

function splitAsteroid(a) {
    if (a.size === "massive")
        return [makeAsteroid("mega", a.x,a.y),
                makeAsteroid("mega", a.x,a.y)];

    if (a.size === "mega")
        return [makeAsteroid("large", a.x,a.y),
                makeAsteroid("large", a.x,a.y)];

    if (a.size === "large")
        return [makeAsteroid("medium", a.x,a.y),
                makeAsteroid("medium", a.x,a.y)];

    if (a.size === "medium")
        return [makeAsteroid("small", a.x,a.y),
                makeAsteroid("small", a.x,a.y)];

    return []; // small disappears
}

function updateAsteroids() {
    asteroids.forEach(a => {
        a.x += a.vx;
        a.y += a.vy;

        if (a.x < 0) a.x += W;
        if (a.x > W) a.x -= W;
        if (a.y < 0) a.y += H;
        if (a.y > H) a.y -= H;

        a.hue = (a.hue + 0.4) % 360;
    });
}

function drawAsteroids() {
    asteroids.forEach(a => {
        ctx.strokeStyle = `hsl(${a.hue}, 90%, 60%)`;
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(a.x, a.y, a.r, 0, Math.PI*2);
        ctx.stroke();
    });
}


/* ============================================================
   ======================== COLLISIONS =========================
   ============================================================ */

let score = 0;

function checkCollisions() {
    // Bullets vs Asteroids
    bullets.forEach((b, bi) => {
        asteroids.forEach((a, ai) => {
            const dx = a.x - b.x;
            const dy = a.y - b.y;
            if (dx*dx + dy*dy < (a.r+2)**2) {

                score += CONST.ASTEROIDS.POINTS[a.size];
                document.getElementById("score").innerText =
                    "Score: " + score;

                bullets.splice(bi, 1);

                const pieces = splitAsteroid(a);
                asteroids.splice(ai, 1, ...pieces);
            }
        });
    });

    // Player vs Asteroid
    asteroids.forEach(a => {
        const dx = a.x - player.x;
        const dy = a.y - player.y;
        if (dx*dx + dy*dy < (a.r + 10)**2) {
            player.alive = false;
        }
    });
}


/* ============================================================
   ======================== GAME LOOP ==========================
   ============================================================ */

function update() {
    if (!player.alive) return; // skip gameplay but draw() still runs

    // movement
    if (keys["ArrowLeft"])  player.angle -= CONST.PLAYER.ROT_SPEED;
    if (keys["ArrowRight"]) player.angle += CONST.PLAYER.ROT_SPEED;
    if (keys["ArrowUp"]) {
        player.vx += Math.cos(player.angle)*CONST.PLAYER.ACCEL;
        player.vy += Math.sin(player.angle)*CONST.PLAYER.ACCEL;
    }

    player.vx *= CONST.PLAYER.DRAG;
    player.vy *= CONST.PLAYER.DRAG;

    if (keys[" "]) shoot();
    if (player.cooldown > 0) player.cooldown--;

    player.x = (player.x + player.vx + W) % W;
    player.y = (player.y + player.vy + H) % H;

    updateBullets();
    updateAsteroids();
    checkCollisions();
}

function draw() {
    ctx.clearRect(0,0,W,H);

    drawStars(stars1);
    drawStars(stars2);
    drawStars(stars3);

    drawBullets();
    drawAsteroids();
    drawPlayer();

    // END SCREEN
    if (!player.alive) {
        ctx.fillStyle = "rgba(0,0,0,0.5)";
        ctx.fillRect(0,0,W,H);

        ctx.fillStyle = "white";
        ctx.font = "60px monospace";
        ctx.fillText("GAME OVER", W/2-170, H/2-20);

        ctx.font = "28px monospace";
        ctx.fillText("Final Score: "+score, W/2-120, H/2+35);

        ctx.font = "22px monospace";
        ctx.fillText("Press R to Restart", W/2-120, H/2+80);
    }
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}


/* ============================================================
   ========================  RESTART  ==========================
   ============================================================ */

function restartGame() {
    resetPlayer();
    bullets = [];
    score = 0;
    document.getElementById("score").innerText = "Score: 0";
    initAsteroids();
}

initAsteroids();
loop();

</script>
</body>
</html>
