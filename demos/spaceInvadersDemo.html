<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Ultimate Space Invaders</title>
<style>
    body {
        background: black;
        display: flex;
        justify-content: center;
        margin: 0;
        font-family: "Courier New", monospace;
        user-select: none;
    }
    #game {
        width: 600px;
        height: 700px;
        background: #000;
        border: 4px solid #0f0;
        position: relative;
        overflow: hidden;
    }

    /* HUD */
    #hud {
        position: absolute;
        width: 100%;
        height: 40px;
        top: 0;
        color: #0f0;
        display: flex;
        justify-content: space-between;
        padding: 5px 10px;
        font-size: 20px;
    }

    .player {
        width: 40px;
        height: 25px;
        background: url('data:image/svg+xml;utf8,\
<svg xmlns="http://www.w3.org/2000/svg" width="40" height="25">\
<rect x="10" y="0" width="20" height="25" fill="lime" />\
<rect x="0" y="8" width="40" height="10" fill="lime" />\
</svg>') center/cover;
        position: absolute;
        bottom: 40px;
        left: 280px;
    }

    .enemy {
        width: 36px;
        height: 26px;
        position: absolute;
        background-size: cover;
    }

    /* Three enemy sprites */
    .type1 {
        background-image: url('data:image/svg+xml;utf8,\
<svg xmlns="http://www.w3.org/2000/svg" width="36" height="26">\
<rect x="6" y="0" width="24" height="6" fill="red" />\
<rect x="0" y="6" width="36" height="14" fill="red" />\
<rect x="8" y="20" width="20" height="6" fill="red" />\
</svg>');
    }

    .type2 {
        background-image: url('data:image/svg+xml;utf8,\
<svg xmlns="http://www.w3.org/2000/svg" width="36" height="26">\
<rect x="0" y="4" width="36" height="6" fill="orange" />\
<rect x="4" y="10" width="28" height="10" fill="orange" />\
</svg>');
    }

    .type3 {
        background-image: url('data:image/svg+xml;utf8,\
<svg xmlns="http://www.w3.org/2000/svg" width="36" height="26">\
<rect x="3" y="3" width="30" height="20" fill="yellow" />\
</svg>');
    }

    .bullet {
        width: 4px;
        height: 12px;
        background: yellow;
        position: absolute;
    }

    .enemyBullet {
        width: 4px;
        height: 12px;
        background: red;
        position: absolute;
    }

    /* Explosion effect */
    .boom {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        position: absolute;
        background: radial-gradient(circle, yellow, red, black);
        opacity: 0.8;
        animation: boomAnim 0.3s ease-out forwards;
    }

    @keyframes boomAnim {
        to { transform: scale(2); opacity: 0; }
    }

    /* Shield blocks */
    .shield {
        width: 14px;
        height: 14px;
        background: #0f0;
        position: absolute;
    }

    /* Center message screens */
    #msg {
        position: absolute;
        width: 100%;
        top: 35%;
        text-align: center;
        font-size: 40px;
        color: #0f0;
        text-shadow: 0 0 8px #0f0;
        display: none;
    }
</style>
</head>
<body>

<div id="game">
    <div id="hud">
        <div id="lives">❤❤❤</div>
        <div id="score">SCORE: 0</div>
    </div>

    <div id="player" class="player"></div>
    <div id="msg"></div>
</div>

<script>
/* ===========================
   SETUP
   =========================== */
const game = document.getElementById("game");
const player = document.getElementById("player");
const scoreDisplay = document.getElementById("score");
const livesDisplay = document.getElementById("lives");
const msg = document.getElementById("msg");

let playerX = 280;
let bullets = [];
let enemyBullets = [];
let enemies = [];
let shields = [];
let score = 0;
let lives = 3;
let enemyDir = 1;
let wave = 1;
let gameOver = false;
let waveActive = true;
let spawningWave = false;
let shootDebounce = false;

/* ===========================
   SOUNDS — generated with Web Audio
   =========================== */
function playSound(freq, dur=0.1, vol=0.2) {
    const audio = new AudioContext();
    const osc = audio.createOscillator();
    const gain = audio.createGain();
    osc.frequency.value = freq;
    gain.gain.value = vol;
    osc.connect(gain);
    gain.connect(audio.destination);
    osc.start();
    osc.stop(audio.currentTime + dur);
}

function shootSound()     { playSound(400); }
function boomSound()      { playSound(80, 0.15, 0.4); }
function hitSound()       { playSound(600, 0.05); }
function loseLifeSound()  { playSound(120, 0.25, 0.6); }

/* ===========================
   SHIELDS
   =========================== */
function createShields() {
    const startX = 100;
    for (let s = 0; s < 3; s++) {
        for (let i = 0; i < 30; i++) {
            const block = document.createElement("div");
            block.className = "shield";
            block.x = startX + s * 150 + (i % 10) * 14;
            block.y = 550 + Math.floor(i / 10) * 14;
            block.style.left = block.x + "px";
            block.style.top = block.y + "px";
            game.appendChild(block);
            shields.push(block);
        }
    }
}
createShields();

/* ===========================
   ENEMY WAVES
   =========================== */
function spawnWave() {
    enemies = [];
    const rows = 4 + wave;  
    const cols = 8;

    for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
            const e = document.createElement("div");
            e.className = "enemy type" + ((r % 3) + 1);
            e.x = 60 + c * 55;
            e.y = 80 + r * 40;
            e.style.left = e.x + "px";
            e.style.top = e.y + "px";
            e.hp = 1 + Math.floor(wave / 2);
            enemies.push(e);
            game.appendChild(e);
        }
    }
}
spawnWave();

/* ===========================
   PLAYER SHOOT
   =========================== */
function shoot() {
    if (gameOver) return;

    if (shootDebounce) return;

    shootDebounce = true;

    shootSound();
    const b = document.createElement("div");
    b.className = "bullet";
    b.x = playerX + 18;
    b.y = 620;
    b.style.left = b.x + "px";
    b.style.top = b.y + "px";
    bullets.push(b);
    game.appendChild(b);

    setTimeout(() => {
        shootDebounce = false;
    }, 200);

}

/* ===========================
   ENEMY SHOOT
   =========================== */
function enemyShoot(e) {
    const b = document.createElement("div");
    b.className = "enemyBullet";
    b.x = e.x + 16;
    b.y = e.y + 20;
    b.style.left = b.x + "px";
    b.style.top = b.y + "px";
    enemyBullets.push(b);
    game.appendChild(b);
}

/* ===========================
   EXPLOSION EFFECT
   =========================== */
function boom(x, y) {
    boomSound();
    const fx = document.createElement("div");
    fx.className = "boom";
    fx.style.left = x + "px";
    fx.style.top = y + "px";
    game.appendChild(fx);
    setTimeout(() => fx.remove(), 300);
}

/* ===========================
   PLAYER INPUT
   =========================== */
document.addEventListener("keydown", e => {
    if (gameOver) return;
    const speed = 12;

    if (e.key === "ArrowLeft")  playerX -= speed;
    if (e.key === "ArrowRight") playerX += speed;
    if (e.key === " ") shoot();

    playerX = Math.max(0, Math.min(560, playerX));
    player.style.left = playerX + "px";
});

/* ===========================
   GAME LOOP FUNCTIONS
   =========================== */

function updateBullets() {
    bullets.forEach(b => {
        b.y -= 8;
        b.style.top = b.y + "px";

        // Delete off-screen
        if (b.y < -20) {
            game.removeChild(b);
            bullets.splice(bullets.indexOf(b), 1);
            return;
        }

        // Hit enemies
        enemies.forEach(e => {
            if (isHit(b, e)) {
                hitSound();
                e.hp--;
                if (e.hp <= 0) {
                    boom(e.x, e.y);
                    score += 10;
                    scoreDisplay.textContent = "SCORE: " + score;
                    game.removeChild(e);
                    enemies.splice(enemies.indexOf(e), 1);
                }
                game.removeChild(b);
                bullets.splice(bullets.indexOf(b), 1);
            }
        });

        // Hit shields
        shields.forEach(s => {
            if (isHit(b, s)) {
                game.removeChild(s);
                shields.splice(shields.indexOf(s), 1);
                game.removeChild(b);
                bullets.splice(bullets.indexOf(b), 1);
            }
        });
    });
}

function updateEnemyBullets() {
    enemyBullets.forEach(b => {
        b.y += 6;
        b.style.top = b.y + "px";

        // off-screen
        if (b.y > 700) {
            game.removeChild(b);
            enemyBullets.splice(enemyBullets.indexOf(b), 1);
            return;
        }

        // hit shields
        shields.forEach(s => {
            if (isHit(b, s)) {
                game.removeChild(s);
                shields.splice(shields.indexOf(s), 1);
                game.removeChild(b);
                enemyBullets.splice(enemyBullets.indexOf(b), 1);
            }
        });

        // hit player
        if (isHit(b, player)) {
            loseLife();
            game.removeChild(b);
            enemyBullets.splice(enemyBullets.indexOf(b), 1);
        }
    });
}

function updateEnemies() {
    let switchDir = false;

    enemies.forEach(e => {
        e.x += enemyDir * (1 + wave * 0.2);
        e.style.left = e.x + "px";

        if (e.x < 10 || e.x > 550) switchDir = true;

        // random enemy shooting
        if (Math.random() < 0.002 * wave) enemyShoot(e);
    });

    if (switchDir) {
        enemyDir *= -1;
        enemies.forEach(e => {
            e.y += 20;
            e.style.top = e.y + "px";

            if (e.y > 600) {
                endGame("GAME OVER<br>They invaded...");
            }
        });
    }

    // NEW wave handler
    if (enemies.length === 0 && waveActive && !spawningWave) {
        waveActive = false;      // current wave ended
        spawningWave = true;     // prevent multiple triggers

        wave++;

        msg.innerHTML = "WAVE " + wave;
        msg.style.display = "block";
        setTimeout(() => msg.style.display = "none", 1200);

        setTimeout(() => {
            spawnWave();
            waveActive = true;   // new wave active
            spawningWave = false;
        }, 2000);  // small break before next wave
    }
}

function loseLife() {
    boom(playerX, 620);
    lives--;
    livesDisplay.textContent = "❤".repeat(lives);

    loseLifeSound();

    if (lives <= 0) {
        endGame("YOU DIED");
    }
}

function endGame(text) {
    gameOver = true;
    msg.innerHTML = text + "<br><br>Refresh to play again";
    msg.style.display = "block";
}

function isHit(a, b) {
    const ar = a.getBoundingClientRect();
    const br = b.getBoundingClientRect();
    return (
        ar.left < br.right &&
        ar.right > br.left &&
        ar.top < br.bottom &&
        ar.bottom > br.top
    );
}

/* ===========================
   MAIN GAME LOOP
   =========================== */
function loop() {
    if (!gameOver) {
        updateBullets();
        updateEnemyBullets();
        updateEnemies();
    }
    requestAnimationFrame(loop);
}
loop();

</script>
</body>
</html>
